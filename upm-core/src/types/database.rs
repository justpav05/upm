//! Структуры для работы с базой данных
//!
//! Этот файл содержит все структуры, связанные с базой данных SQLite,
//! организованные с чёткими комментариями и описаниями.

use sqlx::SqlitePool;
use std::path::PathBuf;

// ============================================================================
// Database Core - Основные структуры для работы с БД
// ============================================================================

/// Основная структура для работы с базой данных
///
/// Управляет пулом соединений SQLite и предоставляет методы для:
/// - CRUD операций с пакетами
/// - Управления подключениями
/// - Валидации и проверки здоровья БД
///
/// # Архитектура
/// Использует пул соединений `SqlitePool` для эффективного управления
/// множественными подключениями к базе данных. Это позволяет:
/// - Переиспользовать соединения
/// - Ограничивать максимальное количество подключений
/// - Автоматически управлять жизненным циклом соединений
///
/// # Безопасность
/// - Все запросы используют prepared statements (защита от SQL-инъекций)
/// - Проверка прав доступа к файлу БД (должен быть 600)
/// - Валидация структуры БД при подключении
///
/// # Примеры
/// ```ignore
/// use upm_core::types::database::DataBase;
///
/// // Создание подключения к БД
/// let db = DataBase::new("/var/lib/upm", "packages.db", 10).await?;
///
/// // Проверка состояния пула
/// let info = db.pool_info();
/// println!("Active connections: {}", info.size);
///
/// // Закрытие всех соединений
/// db.close().await;
/// ```
pub struct DataBase {
    /// Пул соединений с базой данных
    ///
    /// Управляет множественными подключениями к SQLite БД.
    /// Внутренний пул автоматически переиспользует соединения
    /// и ограничивает их максимальное количество.
    pub(crate) pool: SqlitePool,

    /// Путь к файлу базы данных
    ///
    /// Полный путь к .db файлу на диске.
    /// Используется для валидации и получения метаданных файла.
    ///
    /// # Пример
    /// `/var/lib/upm/packages.db`
    pub(crate) database_path: PathBuf,

    /// Максимальное количество соединений в пуле
    ///
    /// Ограничивает количество одновременных подключений к БД.
    /// Рекомендуется: 5-20 для десктопных приложений.
    ///
    /// # Примечание
    /// SQLite поддерживает одновременную запись только из одного потока,
    /// но множественные соединения для чтения работают параллельно.
    pub(crate) max_connections: u32,
}

// ============================================================================
// Pool Info - Информация о состоянии пула соединений
// ============================================================================

/// Информация о состоянии пула соединений с базой данных
///
/// Предоставляет метрики для мониторинга состояния пула:
/// - Общее количество соединений
/// - Количество неиспользуемых соединений
/// - Статус пула (открыт/закрыт)
///
/// # Использование
/// Используется для диагностики и отладки проблем с подключением,
/// а также для мониторинга производительности приложения.
///
/// # Примеры
/// ```ignore
/// let info = database.pool_info();
///
/// if info.idle_connections == 0 && info.size == max_connections {
///     println!("Warning: Pool is exhausted!");
/// }
///
/// if info.is_closed {
///     println!("Error: Pool is closed!");
/// }
/// ```
#[derive(Debug, Clone)]
pub struct PoolInfo {
    /// Общее количество соединений в пуле
    ///
    /// Включает как активные, так и простаивающие соединения.
    /// Не может превышать `max_connections`.
    pub size: u32,

    /// Количество простаивающих (неиспользуемых) соединений
    ///
    /// Соединения, которые готовы к использованию но сейчас не заняты.
    /// Высокое значение означает что пул недоиспользуется.
    /// Низкое значение (особенно 0) может означать нехватку соединений.
    pub idle_connections: usize,

    /// Закрыт ли пул соединений
    ///
    /// `true` если пул был закрыт через `close()` или `close_hard()`.
    /// После закрытия пул нельзя использовать повторно.
    pub is_closed: bool,
}

impl PoolInfo {
    /// Создаёт новый экземпляр PoolInfo
    pub fn new(size: u32, idle_connections: usize, is_closed: bool) -> Self {
        Self {
            size,
            idle_connections,
            is_closed,
        }
    }

    /// Возвращает количество активных (используемых) соединений
    pub fn active_connections(&self) -> usize {
        (self.size as usize).saturating_sub(self.idle_connections)
    }

    /// Проверяет, исчерпан ли пул соединений
    ///
    /// Пул считается исчерпанным если все соединения активны.
    pub fn is_exhausted(&self, max_connections: u32) -> bool {
        self.size == max_connections && self.idle_connections == 0
    }
}
